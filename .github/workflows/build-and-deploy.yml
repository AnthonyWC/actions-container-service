name: Build and Deploy
on: 
  pull_request:
    branches:
    - master
  push:
    branches:
    - master

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master

    - name: Build the Docker container image
      run: docker build -t docker.pkg.github.com/pied-piper-inc/container-service/app-services:latest .

    - name: Push the image to GPR
      run: |
        docker login docker.pkg.github.com -u publisher -p "${GITHUB_PACKAGE_REGISTRY_TOKEN}"
        docker push docker.pkg.github.com/pied-piper-inc/container-service/app-services:latest
      env:
        GITHUB_PACKAGE_REGISTRY_TOKEN: ${{ secrets.GITHUB_PACKAGE_REGISTRY_TOKEN }}

  deploy_to_aws:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to AWS Elastic Container Service
      uses: adhereware/aws-ecs@master
      env:
        AWS_DEFAULT_OUTPUT: json
        AWS_DEFAULT_REGION: us-east-1
        AWS_ECS_CLUSTER: appservices
        AWS_ECS_SERVICE: appservices
        AWS_ECS_TASK_DEFINITION: appservices
        AWS_ACCESS_KEY_ID: AKIAV5FUZIE5RXGHBXTK
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        CONTAINER_IMAGE_NAME: docker.pkg.github.com/pied-piper-inc/container-service/app-services:latest
        # http://ec2co-ecsel-dvl6nmfzlf2j-673816009.us-east-1.elb.amazonaws.com/

  deploy_to_azure:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: azure/actions/login@master
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - uses: azure/appservice-actions/webapp-container@master
      with:
        app-name: 'actionsdemo'
        images: 'docker.pkg.github.com/pied-piper-inc/container-service/app-services:latest'
        # https://actionsdemo.azurewebsites.net/

  deploy_to_google_cloud:
    name: Deploy to Google Cloud
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to Google Kubernetes Engine
      uses: tractionware/google-gke@master
      env:
        GCLOUD_ZONE: us-central1-a
        GCLOUD_KUBE_SERVICE_NAME: appservices
        GCLOUD_KUBE_CONTAINER_NAME: app-services-google
        GCLOUD_PROJECT: lateral-music-215819
        GCLOUD_KUBERNETES_CLUSTER: appservices-cluster
        GCLOUD_KEY_FILE: ${{ secrets.GCLOUD_KEY_FILE }}
        GCLOUD_SERVICE_ACCOUNT: app-services@lateral-music-215819.iam.gserviceaccount.com
        CONTAINER_IMAGE_NAME: docker.pkg.github.com/pied-piper-inc/container-service/app-services:latest
        # http://35.224.70.167
